#+TITLE: Emacs configuration
#+AUTHOR: Nicholas Sim (nw0)
#+PROPERTY: header-args :tangle yes

* Emacs configuration
** Preliminaries
*** About
This is my attempt at a literate emacs configuration.
It's largely because I've found writing comments and multiple files in elisp rather unwieldy.
**** Auto-tangle
Like [[https://github.com/frap/emacs-literate/blob/master/readme.org][Andrés Gasson]], I define this property to tangle most code blocks in this file.
#+BEGIN_SRC org :tangle no
#+PROPERTY: header-args :tangle yes
#+END_SRC
*** Inspiration
- [[https://github.com/frap/emacs-literate/blob/master/readme.org][Andrés Gasson]]

** Pre-initialisation
This saves me about 0.3s.
#+BEGIN_SRC emacs-lisp
(eval-and-compile
  (setq gc-cons-threshold (* 256 1024 1024)
        gc-cons-percentage 10.0))
#+END_SRC

** Packages
*** Another optimisation
Avoid calling =(package-initialize)= for performance; this saves me about 0.3s.
#+BEGIN_SRC emacs-lisp
(eval-and-compile
  (setq load-prefer-newer t
        package-user-dir "~/.emacs.d/elpa"
        package--init-file-ensured t
        package-enable-at-startup nil)

  (unless (file-directory-p package-user-dir)
    (make-directory package-user-dir t))
  (setq load-path (append load-path (directory-files package-user-dir t "^[^.]" t))))
#+END_SRC

*** Want org, melpa
#+BEGIN_SRC emacs-lisp
(eval-when-compile
  (require 'package)

  (setq gnutls-min-prime-bits 4096)
  (unless (assoc-default "melpa" package-archives)
    (add-to-list 'package-archives '("melpa" . "http://melpa.org/packages/") t))
  (unless (assoc-default "org" package-archives)
    (add-to-list 'package-archives '("org" . "http://orgmode.org/elpa/") t)))
#+END_SRC

*** Can't live without =use-package=
#+BEGIN_SRC emacs-lisp
(setq use-package-always-defer t
      use-package-verbose t)

(eval-when-compile
  (package-initialize)
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))
  (unless (package-installed-p 'bind-key)
    (package-refresh-contents)
    (package-install 'bind-key))
  (require 'use-package)
  (require 'bind-key))
#+END_SRC

** Load other files
To begin, I've copied this directly from =init.el=.

#+BEGIN_SRC emacs-lisp
;; Custom things
(setq custom-file "~/.emacs.d/custom.el")
(load custom-file)

(load-file "~/.emacs.d/org.el")
(load-file "~/.emacs.d/interface.el")
(load-file "~/.emacs.d/edit.el")
(load-file "~/.emacs.d/evil.el")
(load-file "~/.emacs.d/modes.el")

;; less frequent garbage collection
(setq gc-cons-threshold (* 100 1024 1024)) ;; 100 mb
;; Allow font-lock-mode to do background parsing
(setq jit-lock-stealth-time 1
      ;; jit-lock-stealth-load 200
      jit-lock-chunk-size 1000
      jit-lock-defer-time 0.05)
;; this helps org-bullets (and other unicode things?) load faster
(setq inhibit-compacting-font-caches t)
#+END_SRC

** Post-initialisation
Set this to a slightly less obnoxious value at end of init.
#+BEGIN_SRC emacs-lisp
(setq gc-cons-threshold (* 100 1024 1024)
      gc-cons-percentage 0.2)
#+END_SRC
